{% extends "layout.html" %}

{% block title %}Quản lý học sinh{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item">
    <a href="{{ url_for('admin.dashboard') }}" class="text-decoration-none">
        <i class="fas fa-home me-1"></i>Trang chủ
    </a>
</li>
<li class="breadcrumb-item active" aria-current="page">
    Quản lý học sinh
</li>
{% endblock %}

{% block layout_content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <form class="row g-3" id="filterForm" autocomplete="off" onsubmit="return false;">
                        <div class="col-md-3">
                            <label class="form-label">Tìm kiếm</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="Tên, mã học sinh...">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Lớp học</label>
                            <select class="form-select" id="classroomFilter">
                                <option value="">Tất cả</option>
                                <!-- Options will be loaded by JavaScript -->
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Giới tính</label>
                            <select class="form-select" id="genderFilter">
                                <option value="">Tất cả</option>
                                <option value="Nam">Nam</option>
                                <option value="Nữ">Nữ</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Trạng thái</label>
                            <select class="form-select" id="statusFilter">
                                <option value="">Tất cả</option>
                                <option value="active">Hoạt động</option>
                                <option value="inactive">Tạm khóa</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end gap-2">
                            <button type="button" class="btn btn-outline-secondary" onclick="resetFilters()" title="Đặt lại bộ lọc">
                                <i class="fas fa-redo"></i>
                            </button>
                            <button type="submit" class="btn btn-primary" id="searchBtn" title="Tìm kiếm">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Header -->
            <div class="page-header">
                <h2 class="page-header-title">
                    <i class="fas fa-user-graduate me-2" style="color: #3b82f6;"></i>
                    Danh sách học sinh
                </h2>
                <div class="page-header-actions">
                    
                    <a href="{{ url_for('student.form') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        Thêm học sinh
                    </a>
                </div>
            </div>
            
            <!-- Students Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="studentsTable">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">
                                        <input type="checkbox" class="form-check-input" id="selectAll">
                                    </th>
                                    <th>STT</th>
                                    <th>Mã học sinh</th>
                                    <th>Họ và tên</th>
                                    <th>Giới tính</th>
                                    <th>Ngày sinh</th>
                                    <th>Lớp học</th>
                                    <th>Nhận diện khuôn mặt</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <nav aria-label="Student pagination" class="mt-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                Hiển thị <span id="showingInfo">0 - 0 của 0</span>
                            </small>
                            <ul class="pagination pagination-sm mb-0" id="pagination">
                                <!-- Pagination will be populated by JavaScript -->
                            </ul>
                        </div>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPage = 1;
    let currentLimit = 10;
    let currentSearch = '';
    let currentClassroom = '';
    let currentGender = '';
    let currentStatus = '';

    // Initialize student management
    function initializeStudentManagement() {
        loadClassroomOptions();
        loadStudentList();
        setupEventListeners();
    }

    // Load classroom options
    async function loadClassroomOptions() {
        try {
            const response = await fetch('/classroom/api/list?limit=1000');
            const data = await response.json();
            
            if (data.success) {
                const select = document.getElementById('classroomFilter');
                select.innerHTML = '<option value="">Tất cả</option>';
                
                data.data.classrooms.forEach(classroom => {
                    const option = document.createElement('option');
                    option.value = classroom.id;
                    option.textContent = `${classroom.class_name} (${classroom.student_count || 0} học sinh)`;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading classrooms:', error);
        }
    }

    // Setup event listeners
    function setupEventListeners() {
        // Submit filter form
        document.getElementById('filterForm').addEventListener('submit', function(e) {
            e.preventDefault();
            currentSearch = document.getElementById('searchInput').value;
            currentClassroom = document.getElementById('classroomFilter').value;
            currentGender = document.getElementById('genderFilter').value;
            currentStatus = document.getElementById('statusFilter').value;
            currentPage = 1;
            loadStudentList();
        });

        // Enter key in search input submits form
        document.getElementById('searchInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('searchBtn').click();
            }
        });

        // Select all checkbox
        document.getElementById('selectAll').addEventListener('change', function(e) {
            const checkboxes = document.querySelectorAll('#studentsTable tbody input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = e.target.checked);
        });
    }

    // Load student list
    async function loadStudentList() {
        try {
            const params = new URLSearchParams({
                page: currentPage,
                limit: currentLimit
            });
            
            if (currentSearch) params.append('search', currentSearch);
            if (currentClassroom) params.append('classroom_id', currentClassroom);
            if (currentGender) params.append('gender', currentGender);
            if (currentStatus) params.append('status', currentStatus);

            const response = await fetch(`/student/api/list?${params}`);
            const data = await response.json();
            
            if (data.success) {
                console.log('Student data:', data.data);
                renderStudentList(data.data.students);
                renderPagination(data.data);
                updateShowingInfo(data.data);
            } else {
                window.FaceID?.NotificationSystem?.error(data.message || 'Lỗi khi tải danh sách học sinh');
            }
        } catch (error) {
            console.error('Error loading students:', error);
            window.FaceID?.NotificationSystem?.error('Lỗi kết nối khi tải danh sách học sinh');
        }
    }

    // Render student list
    function renderStudentList(students) {
        const tbody = document.querySelector('#studentsTable tbody');
        
        if (!students || students.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="text-center text-muted py-4">
                        <i class="fas fa-graduation-cap fa-2x mb-2 d-block"></i>
                        Không có học sinh nào
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = students.map((student, index) => {
            const stt = (currentPage - 1) * currentLimit + index + 1;
            const statusBadge = student.is_active 
                ? '<span class="badge bg-success">Hoạt động</span>'
                : '<span class="badge bg-secondary">Tạm khóa</span>';
            
            const genderBadge = student.gender === 'Nam' 
                ? '<span class="badge bg-primary">Nam</span>'
                : '<span class="badge bg-info">Nữ</span>';

            const birthDate = student.date_of_birth 
                ? new Date(student.date_of_birth).toLocaleDateString('vi-VN')
                : 'Chưa có';

            const faceRecognition = student.face_recognition_enabled
                ? `<span class="badge bg-success">
                     <i class="fas fa-check me-1"></i>${student.face_images_count} ảnh
                   </span>`
                : `<span class="badge bg-warning text-dark">
                     <i class="fas fa-exclamation me-1"></i>${student.face_images_count || 0} ảnh
                   </span>`;

            const classroomName = student.classroom.class_name || '<span class="text-muted">Chưa có lớp</span>';

            return `
                <tr>
                    <td>
                        <input type="checkbox" class="form-check-input" value="${student.id}">
                    </td>
                    <td>${stt}</td>
                    <td><code>${student.student_code}</code></td>
                    <td>
                        <div class="d-flex align-items-center">
                            ${student.avatar_url 
                                ? `<img src="${student.avatar_url}" class="rounded-circle me-2" width="32" height="32" alt="Avatar">`
                                : `<div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                     <span class="text-white fw-bold">${student.full_name.charAt(0)}</span>
                                   </div>`
                            }
                            <div>
                                <strong>${student.full_name}</strong>
                                ${student.phone ? `<br><small class="text-muted">${student.phone}</small>` : ''}
                            </div>
                        </div>
                    </td>
                    <td>${genderBadge}</td>
                    <td>${birthDate}</td>
                    <td>${classroomName}</td>
                    <td>${faceRecognition}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <a href="/student/form?id=${student.id}" class="btn btn-outline-primary btn-sm" title="Chỉnh sửa">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="/student/${student.id}/image-upload" class="btn btn-outline-secondary btn-sm" title="Quản lý ảnh">
                                <i class="fas fa-camera"></i>
                            </a>
                            ${student.is_active 
                                ? `<button type="button" class="btn btn-outline-warning btn-sm" onclick="toggleStudentStatus(${student.id}, 'deactivate')" title="Tạm khóa">
                                    <i class="fas fa-lock"></i>
                                </button>`
                                : `<button type="button" class="btn btn-outline-success btn-sm" onclick="toggleStudentStatus(${student.id}, 'activate')" title="Kích hoạt">
                                    <i class="fas fa-unlock"></i>
                                </button>`
                            }
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteStudent(${student.id})" title="Xóa">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Toggle student status
    window.toggleStudentStatus = async function(studentId, action) {
        const actionText = action === 'activate' ? 'kích hoạt' : 'khóa';
        const modalHtml = `
            <div class="modal fade" id="confirmModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Xác nhận ${actionText}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            Bạn có chắc chắn muốn ${actionText} học sinh này không?
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                            <button type="button" class="btn btn-primary" id="confirmBtn">Xác nhận</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHtml;
        document.body.appendChild(modalContainer);

        const modal = new bootstrap.Modal(modalContainer.querySelector('.modal'));
        const confirmBtn = modalContainer.querySelector('#confirmBtn');

        confirmBtn.addEventListener('click', async function() {
            modal.hide();

            try {
                const endpoint = action === 'activate' ? 'activate' : 'deactivate';
                const response = await fetch(`/student/api/${studentId}/${endpoint}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    window.FaceID?.NotificationSystem?.success(`${actionText.charAt(0).toUpperCase() + actionText.slice(1)} học sinh thành công`);
                    loadStudentList();
                } else {
                    window.FaceID?.NotificationSystem?.error(data.message || `Lỗi khi ${actionText} học sinh`);
                }
            } catch (error) {
                console.error(`Error ${action} student:`, error);
                window.FaceID?.NotificationSystem?.error(`Lỗi kết nối khi ${actionText} học sinh`);
            } finally {
                modalContainer.remove();
            }
        });

        modal.show();
    };

    // Delete student
    window.deleteStudent = async function(studentId) {
        const modalHtml = `
            <div class="modal fade" id="confirmModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title text-danger">Xác nhận xóa</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            Bạn có chắc chắn muốn xóa học sinh này không? Hành động này không thể hoàn tác!
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                            <button type="button" class="btn btn-danger" id="confirmBtn">Xóa</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHtml;
        document.body.appendChild(modalContainer);

        const modal = new bootstrap.Modal(modalContainer.querySelector('.modal'));
        const confirmBtn = modalContainer.querySelector('#confirmBtn');

        confirmBtn.addEventListener('click', async function() {
            modal.hide();

            try {
                const response = await fetch(`/student/api/${studentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    window.FaceID?.NotificationSystem?.success('Xóa học sinh thành công');
                    loadStudentList();
                } else {
                    window.FaceID?.NotificationSystem?.error(data.message || 'Lỗi khi xóa học sinh');
                }
            } catch (error) {
                console.error('Error deleting student:', error);
                window.FaceID?.NotificationSystem?.error('Lỗi kết nối khi xóa học sinh');
            } finally {
                modalContainer.remove();
            }
        });

        modal.show();
    };

    // Import students
    window.importStudents = function() {
        window.location.href = '/student/import';
    };

    // Export students
    window.exportStudents = function() {
        window.location.href = '/student/export';
    };

    // Reset filters
    window.resetFilters = function() {
        document.getElementById('searchInput').value = '';
        document.getElementById('classroomFilter').value = '';
        document.getElementById('genderFilter').value = '';
        document.getElementById('statusFilter').value = '';
        
        currentPage = 1;
        currentSearch = '';
        currentClassroom = '';
        currentGender = '';
        currentStatus = '';
        
        loadStudentList();
        if (window.FaceID && FaceID.NotificationSystem) {
            FaceID.NotificationSystem.success('Đã đặt lại bộ lọc');
        }
    };

    // Pagination functions (same as classroom)
    function renderPagination(pagination) {
        const paginationEl = document.getElementById('pagination');
        const totalPages = pagination.pages;
        
        if (totalPages <= 1) {
            paginationEl.innerHTML = '';
            return;
        }

        let paginationHTML = '';
        
        if (currentPage > 1) {
            paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage - 1})">‹</a></li>`;
        }
        
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);
        
        if (startPage > 1) {
            paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(1)">1</a></li>`;
            if (startPage > 2) {
                paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>`;
        }
        
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
            paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${totalPages})">${totalPages}</a></li>`;
        }
        
        if (currentPage < totalPages) {
            paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage + 1})">›</a></li>`;
        }
        
        paginationEl.innerHTML = paginationHTML;
    }

    window.changePage = function(page) {
        currentPage = page;
        loadStudentList();
    };

    function updateShowingInfo(pagination) {
        const start = (currentPage - 1) * currentLimit + 1;
        const end = Math.min(currentPage * currentLimit, pagination.total);
        const total = pagination.total;
        
        document.getElementById('showingInfo').textContent = `${start} - ${end} của ${total}`;
    }

    // Initialize on page load
    initializeStudentManagement();
});
</script>
{% endblock %}
