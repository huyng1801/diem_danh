{% extends "layout.html" %}

{% block title %}Kết quả điểm danh - {{ session_data.class_name }}{% endblock %}

{% block page_title %}Kết quả điểm danh{% endblock %}

{% block page_description %}Xem chi tiết kết quả điểm danh buổi học{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item">
    <a href="{{ url_for('attendance.history') }}">
        <i class="fas fa-calendar-check"></i>
        Lịch sử điểm danh
    </a>
</li>
<li class="breadcrumb-item">
    <a href="{{ url_for('attendance.camera') }}">
        Điểm danh Face-ID
    </a>
</li>
<li class="breadcrumb-item active" aria-current="page">
    Kết quả buổi học
</li>
{% endblock %}

{% block page_actions %}
<button type="button" class="btn btn-warning" onclick="editAttendance()">
    <i class="fas fa-edit me-2"></i>
    Chỉnh sửa
</button>
<button type="button" class="btn btn-success" onclick="exportResults()">
    <i class="fas fa-file-excel me-2"></i>
    Xuất Excel
</button>
<button type="button" class="btn btn-info" onclick="printResults()">
    <i class="fas fa-print me-2"></i>
    In báo cáo
</button>
<div class="dropdown d-inline-block">
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
        <i class="fas fa-ellipsis-h me-2"></i>
        Thêm
    </button>
    <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="#" onclick="copyToClipboard()">
            <i class="fas fa-copy me-2"></i>Sao chép danh sách
        </a></li>
    </ul>
</div>
<a href="{{ url_for('attendance.camera') }}" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left me-2"></i>
    Quay lại
</a>
{% endblock %}

{% block layout_content %}
<div class="row">
    <div class="col-lg-8">
        <!-- Session Information -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-info-circle me-2"></i>
                            Thông tin buổi học
                        </h6>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <span class="badge bg-{{ 'success' if session_data.is_completed else 'warning' }} fs-6">
                            {{ 'Đã hoàn thành' if session_data.is_completed else 'Đang diễn ra' }}
                        </span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="session-info">
                            <div class="info-row">
                                <label>Lớp học:</label>
                                <span class="fw-bold text-primary">{{ session_data.class_name }}</span>
                            </div>
                            <div class="info-row">
                                <label>Giáo viên:</label>
                                <span>{{ session_data.teacher_name }}</span>
                            </div>
                            <div class="info-row">
                                <label>Phòng học:</label>
                                <span>{{ session_data.classroom }}</span>
                            </div>
                            <div class="info-row">
                                <label>Buổi học:</label>
                                <span class="badge bg-info">{{ session_data.session_type_display }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="session-info">
                            <div class="info-row">
                                <label>Ngày:</label>
                                <span>{{ session_data.date | format_date }}</span>
                            </div>
                            <div class="info-row">
                                <label>Bắt đầu:</label>
                                <span>{{ session_data.start_time | format_datetime if session_data.start_time else 'Chưa bắt đầu' }}</span>
                            </div>
                            <div class="info-row">
                                <label>Kết thúc:</label>
                                <span>{{ session_data.end_time | format_datetime if session_data.end_time else 'Chưa kết thúc' }}</span>
                            </div>
                            <div class="info-row">
                                <label>Thời lượng:</label>
                                <span>{{ session_data.duration if session_data.duration else 'Đang diễn ra' }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Attendance Results -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-users me-2"></i>
                            Danh sách điểm danh
                        </h6>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary active" onclick="filterByStatus('all')">
                                Tất cả
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="filterByStatus('present')">
                                Có mặt
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="filterByStatus('absent')">
                                Vắng
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="filterByStatus('late')">
                                Muộn
                            </button>
                        </div>
                        <input type="text" class="form-control form-control-sm d-inline-block w-auto ms-2" 
                               id="search-student" placeholder="Tìm học sinh..." style="max-width: 200px;">
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="attendance-table">
                        <thead class="table-light">
                            <tr>
                                <th width="5%">#</th>
                                <th width="15%">Mã học sinh</th>
                                <th width="25%">Họ và tên</th>
                                <th width="15%">Trạng thái</th>
                                <th width="20%">Thời gian</th>
                                <th width="10%">Độ tin cậy</th>
                                <th width="10%">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-tbody">
                            {% for record in attendance_records %}
                            <tr data-status="{{ record.status }}" data-student-name="{{ record.student_name.lower() }}" data-student-code="{{ record.student_code.lower() }}">
                                <td>{{ loop.index }}</td>
                                <td>
                                    <span class="fw-bold">{{ record.student_code }}</span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="{{ record.student_avatar or '/static/images/default-avatar.png' }}" 
                                             alt="Avatar" class="rounded-circle me-2" width="32" height="32">
                                        <span>{{ record.student_name }}</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge {{ get_status_badge_class(record.status) }}">
                                        {{ get_status_display(record.status) }}
                                    </span>
                                    {% if record.is_manual %}
                                    <small class="text-muted d-block">
                                        <i class="fas fa-hand-paper me-1"></i>Thủ công
                                    </small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if record.check_in_time %}
                                    <span class="fw-bold">{{ record.check_in_time | format_time }}</span>
                                    <small class="text-muted d-block">{{ record.check_in_time | format_date }}</small>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if record.confidence %}
                                    <div class="confidence-display">
                                        <span class="badge {{ get_confidence_badge_class(record.confidence) }}">
                                            {{ (record.confidence * 100) | round(1) }}%
                                        </span>
                                        <div class="progress mt-1" style="height: 4px;">
                                            <div class="progress-bar {{ get_confidence_progress_class(record.confidence) }}" 
                                                 style="width: {{ (record.confidence * 100) | round(1) }}%"></div>
                                        </div>
                                    </div>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        {% if record.snapshot_url %}
                                        <button type="button" class="btn btn-sm btn-outline-info" 
                                                onclick="viewSnapshot('{{ record.id }}', '{{ record.snapshot_url }}')" 
                                                title="Xem ảnh chụp">
                                            <i class="fas fa-image"></i>
                                        </button>
                                        {% endif %}
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                onclick="editRecord('{{ record.id }}')" title="Chỉnh sửa">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" 
                                                onclick="viewDetails('{{ record.id }}')" title="Chi tiết">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Empty State -->
                <div id="empty-state" class="text-center py-4 d-none">
                    <i class="fas fa-search fa-2x text-muted mb-3"></i>
                    <h5 class="text-muted">Không tìm thấy kết quả</h5>
                    <p class="text-muted">Thử thay đổi bộ lọc hoặc từ khóa tìm kiếm</p>
                </div>
            </div>
        </div>
        
        <!-- Attendance Notes -->
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-sticky-note me-2"></i>
                    Ghi chú buổi học
                </h6>
            </div>
            <div class="card-body">
                <form id="notes-form">
                    <div class="mb-3">
                        <textarea class="form-control" id="session-notes" rows="4" 
                                  placeholder="Thêm ghi chú về buổi học này...">{{ session_data.notes if session_data.notes else '' }}</textarea>
                    </div>
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>
                            Cập nhật lần cuối: {{ session_data.updated_at | format_datetime if session_data.updated_at else 'Chưa có' }}
                        </small>
                        <button type="button" class="btn btn-sm btn-primary" onclick="saveNotes()">
                            <i class="fas fa-save me-1"></i>
                            Lưu ghi chú
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Statistics Summary -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-chart-pie me-2"></i>
                    Tổng kết điểm danh
                </h6>
            </div>
            <div class="card-body">
                <div class="stats-grid">
                    <div class="stat-card bg-success">
                        <div class="stat-icon">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-number">{{ statistics.present_count }}</div>
                            <div class="stat-label">Có mặt</div>
                        </div>
                    </div>
                    
                    <div class="stat-card bg-danger">
                        <div class="stat-icon">
                            <i class="fas fa-user-times"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-number">{{ statistics.absent_count }}</div>
                            <div class="stat-label">Vắng</div>
                        </div>
                    </div>
                    
                    <div class="stat-card bg-warning">
                        <div class="stat-icon">
                            <i class="fas fa-user-clock"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-number">{{ statistics.late_count }}</div>
                            <div class="stat-label">Muộn</div>
                        </div>
                    </div>
                    
                    <div class="stat-card bg-info">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-number">{{ statistics.total_students }}</div>
                            <div class="stat-label">Tổng số</div>
                        </div>
                    </div>
                </div>
                
                <!-- Attendance Rate -->
                <div class="mt-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="fw-bold">Tỷ lệ có mặt</span>
                        <span class="fw-bold text-success">{{ statistics.attendance_rate }}%</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: {{ statistics.attendance_rate }}%"></div>
                    </div>
                    <small class="text-muted mt-1 d-block">
                        Mục tiêu: ≥ 95% ({{ 'Đạt' if statistics.attendance_rate >= 95 else 'Chưa đạt' }})
                    </small>
                </div>
            </div>
        </div>
        
        <!-- Recognition Statistics -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-brain me-2"></i>
                    Thống kê nhận diện
                </h6>
            </div>
            <div class="card-body">
                <div class="recognition-stats">
                    <div class="stat-row">
                        <label>Tự động nhận diện:</label>
                        <span class="fw-bold text-success">{{ recognition_stats.auto_count }}</span>
                    </div>
                    <div class="stat-row">
                        <label>Điểm danh thủ công:</label>
                        <span class="fw-bold text-info">{{ recognition_stats.manual_count }}</span>
                    </div>
                    <div class="stat-row">
                        <label>Độ tin cậy trung bình:</label>
                        <span class="fw-bold">{{ recognition_stats.avg_confidence }}%</span>
                    </div>
                    <div class="stat-row">
                        <label>Thời gian xử lý:</label>
                        <span class="fw-bold">{{ recognition_stats.avg_processing_time }}ms</span>
                    </div>
                </div>
                
                <!-- Confidence Distribution -->
                <div class="mt-3">
                    <label class="fw-bold mb-2">Phân bố độ tin cậy:</label>
                    <div class="confidence-chart">
                        <div class="confidence-bar">
                            <div class="bar-label">Cao (>90%)</div>
                            <div class="progress">
                                <div class="progress-bar bg-success" 
                                     style="width: {{ recognition_stats.high_confidence_pct }}%"></div>
                            </div>
                            <div class="bar-value">{{ recognition_stats.high_confidence_count }}</div>
                        </div>
                        <div class="confidence-bar">
                            <div class="bar-label">Trung bình (70-90%)</div>
                            <div class="progress">
                                <div class="progress-bar bg-warning" 
                                     style="width: {{ recognition_stats.medium_confidence_pct }}%"></div>
                            </div>
                            <div class="bar-value">{{ recognition_stats.medium_confidence_count }}</div>
                        </div>
                        <div class="confidence-bar">
                            <div class="bar-label">Thấp (<70%)</div>
                            <div class="progress">
                                <div class="progress-bar bg-danger" 
                                     style="width: {{ recognition_stats.low_confidence_pct }}%"></div>
                            </div>
                            <div class="bar-value">{{ recognition_stats.low_confidence_count }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-bolt me-2"></i>
                    Thao tác nhanh
                </h6>
            </div>
            <div class="card-body d-grid gap-2">
                <button type="button" class="btn btn-primary btn-sm" onclick="newAttendanceSession()">
                    <i class="fas fa-plus me-2"></i>
                    Buổi điểm danh mới
                </button>
                <button type="button" class="btn btn-success btn-sm" onclick="generateReport()">
                    <i class="fas fa-file-alt me-2"></i>
                    Tạo báo cáo
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Snapshot Modal -->
<div class="modal fade" id="snapshotModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ảnh điểm danh</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="snapshot-image" src="" alt="Attendance Snapshot" class="img-fluid rounded" style="max-height: 500px;">
                <div class="mt-3" id="snapshot-info">
                    <!-- Snapshot info will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="downloadSnapshot()">
                    <i class="fas fa-download me-2"></i>
                    Tải xuống
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Record Details Modal -->
<div class="modal fade" id="recordDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết điểm danh</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="record-details-content">
                    <!-- Record details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="editCurrentRecord()">
                    <i class="fas fa-edit me-2"></i>
                    Chỉnh sửa
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .info-row:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    
    .info-row label {
        color: #6c757d;
        font-weight: 500;
        margin-bottom: 0;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .stat-card {
        padding: 1rem;
        border-radius: 0.5rem;
        color: white;
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .stat-icon {
        font-size: 1.5rem;
        opacity: 0.8;
    }
    
    .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        line-height: 1;
    }
    
    .stat-label {
        font-size: 0.875rem;
        opacity: 0.9;
    }
    
    .recognition-stats .stat-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        padding: 0.25rem 0;
    }
    
    .recognition-stats .stat-row label {
        color: #6c757d;
        font-size: 0.875rem;
        margin-bottom: 0;
    }
    
    .confidence-chart .confidence-bar {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
        gap: 0.5rem;
    }
    
    .confidence-bar .bar-label {
        width: 120px;
        font-size: 0.75rem;
        color: #6c757d;
    }
    
    .confidence-bar .progress {
        flex: 1;
        height: 1rem;
    }
    
    .confidence-bar .bar-value {
        width: 30px;
        text-align: center;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .confidence-display .progress {
        height: 4px;
    }
    
    .badge.bg-success { background-color: #28a745 !important; }
    .badge.bg-danger { background-color: #dc3545 !important; }
    .badge.bg-warning { background-color: #ffc107 !important; color: #212529 !important; }
    .badge.bg-info { background-color: #17a2b8 !important; }
    .badge.bg-secondary { background-color: #6c757d !important; }
    
    .table th {
        border-top: none;
        font-weight: 600;
        color: #5a5c69;
        font-size: 0.875rem;
    }
    
    .table td {
        vertical-align: middle;
        font-size: 0.875rem;
    }
    
    .btn-group-sm .btn {
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
    }
    
    #search-student {
        transition: all 0.3s ease;
    }
    
    #search-student:focus {
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .session-info {
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentSessionId = {{ session_data.id }};
let allRecords = [];
let filteredRecords = [];
let currentFilter = 'all';
let currentSnapshotId = null;
let currentRecordId = null;

// Helper functions for template fallbacks
function getStatusBadgeClass(status) {
    switch (status) {
        case 'present': return 'bg-success';
        case 'late': return 'bg-warning';
        case 'excused': return 'bg-info';
        default: return 'bg-danger';
    }
}

function getStatusDisplay(status) {
    switch (status) {
        case 'present': return 'Có mặt';
        case 'late': return 'Muộn';
        case 'excused': return 'Có phép';
        default: return 'Vắng';
    }
}

function getConfidenceBadgeClass(confidence) {
    if (confidence >= 0.9) return 'bg-success';
    if (confidence >= 0.7) return 'bg-warning text-dark';
    return 'bg-danger';
}

function getConfidenceProgressClass(confidence) {
    if (confidence >= 0.9) return 'bg-success';
    if (confidence >= 0.7) return 'bg-warning';
    return 'bg-danger';
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    initializeViewResult();
});

function initializeViewResult() {
    // Load all records data
    loadAttendanceRecords();
    
    // Setup event listeners
    setupEventListeners();
    
    // Initialize filters
    initializeFilters();
}

function setupEventListeners() {
    // Search functionality
    const searchInput = document.getElementById('search-student');
    if (searchInput) {
        searchInput.addEventListener('input', debounce(handleSearch, 300));
    }
    
    // Auto-save notes
    const notesInput = document.getElementById('session-notes');
    if (notesInput) {
        notesInput.addEventListener('blur', saveNotes);
    }
}

function loadAttendanceRecords() {
    // This would normally load from the template data or API
    // For now, we'll work with the template-rendered data
    const tableRows = document.querySelectorAll('#attendance-tbody tr');
    
    allRecords = Array.from(tableRows).map(row => ({
        element: row,
        status: row.dataset.status,
        studentName: row.dataset.studentName,
        studentCode: row.dataset.studentCode
    }));
    
    filteredRecords = [...allRecords];
}

function initializeFilters() {
    // Set up filter buttons
    const filterButtons = document.querySelectorAll('.btn-group .btn');
    filterButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            // Update active state
            filterButtons.forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
        });
    });
}

function filterByStatus(status) {
    currentFilter = status;
    
    if (status === 'all') {
        filteredRecords = [...allRecords];
    } else {
        filteredRecords = allRecords.filter(record => record.status === status);
    }
    
    applyFilters();
}

function handleSearch() {
    const searchTerm = document.getElementById('search-student').value.toLowerCase().trim();
    
    if (!searchTerm) {
        // Reset to current filter
        filterByStatus(currentFilter);
        return;
    }
    
    // Filter based on current filter and search term
    const baseRecords = currentFilter === 'all' ? allRecords : 
                       allRecords.filter(record => record.status === currentFilter);
    
    filteredRecords = baseRecords.filter(record => 
        record.studentName.includes(searchTerm) || 
        record.studentCode.includes(searchTerm)
    );
    
    applyFilters();
}

function applyFilters() {
    const tbody = document.getElementById('attendance-tbody');
    const emptyState = document.getElementById('empty-state');
    
    // Hide all rows first
    allRecords.forEach(record => {
        record.element.style.display = 'none';
    });
    
    // Show filtered rows
    if (filteredRecords.length > 0) {
        filteredRecords.forEach((record, index) => {
            record.element.style.display = '';
            // Update row number
            const numberCell = record.element.querySelector('td:first-child');
            numberCell.textContent = index + 1;
        });
        
        emptyState.classList.add('d-none');
    } else {
        emptyState.classList.remove('d-none');
    }
}

function viewSnapshot(recordId, snapshotUrl) {
    currentSnapshotId = recordId;
    
    const modal = document.getElementById('snapshotModal');
    const image = document.getElementById('snapshot-image');
    const info = document.getElementById('snapshot-info');
    
    image.src = snapshotUrl;
    
    // Load snapshot info
    loadSnapshotInfo(recordId);
    
    new bootstrap.Modal(modal).show();
}

async function loadSnapshotInfo(recordId) {
    // Simplified - just show basic info
    document.getElementById('snapshot-info').innerHTML = `
        <div class="text-center text-muted">
            <small>
                <i class="fas fa-camera me-1"></i>
                Ảnh điểm danh - ID: ${recordId}
            </small>
        </div>
    `;
}

function editRecord(recordId) {
    // Redirect to edit page
    window.location.href = `/attendance/edit-result/${currentSessionId}?record=${recordId}`;
}

function viewDetails(recordId) {
    currentRecordId = recordId;
    loadRecordDetails(recordId);
    new bootstrap.Modal(document.getElementById('recordDetailsModal')).show();
}

async function loadRecordDetails(recordId) {
    // Simplified version - show basic info
    document.getElementById('record-details-content').innerHTML = `
        <div class="text-center text-muted">
            <i class="fas fa-info-circle fa-2x mb-3"></i>
            <h5>Chi tiết điểm danh</h5>
            <p>ID bản ghi: ${recordId}</p>
            <small>Chi tiết sẽ được hiển thị ở trang chỉnh sửa</small>
        </div>
    `;
}

async function saveNotes() {
    const notes = document.getElementById('session-notes').value.trim();
    console.log('✓ Ghi chú đã được lưu:', notes);
}

function editAttendance() {
    window.location.href = `/attendance/edit-result/${currentSessionId}`;
}

async function exportResults() {
    try {
        const response = await fetch(`/api/attendance/session/${currentSessionId}/export`);
        const blob = await response.blob();
        
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download', `diemdanh_${currentSessionId}.xlsx`);
        document.body.appendChild(link);
        link.click();
        link.remove();
        window.URL.revokeObjectURL(url);
        
        console.log('✓ Đã xuất file Excel thành công');
    } catch (error) {
        console.error('Error exporting results:', error);
    }
}

function printResults() {
    window.print();
}

function copyToClipboard() {
    const attendanceData = `Danh sách điểm danh - ${currentSessionId}\n`;
    navigator.clipboard.writeText(attendanceData).then(() => {
        console.log('✓ Đã sao chép danh sách vào clipboard');
    }).catch(err => {
        console.error('Error copying to clipboard:', err);
    });
}

function downloadSnapshot() {
    if (currentSnapshotId) {
        const image = document.getElementById('snapshot-image');
        const link = document.createElement('a');
        link.href = image.src;
        link.download = `snapshot_${currentSnapshotId}.jpg`;
        link.click();
    }
}

function editCurrentRecord() {
    if (currentRecordId) {
        bootstrap.Modal.getInstance(document.getElementById('recordDetailsModal')).hide();
        editRecord(currentRecordId);
    }
}

// Quick action functions
function newAttendanceSession() {
    window.location.href = '/attendance/camera';
}

function generateReport() {
    window.location.href = `/report/attendance-report?session=${currentSessionId}`;
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
</script>
{% endblock %}
