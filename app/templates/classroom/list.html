{% extends "layout.html" %}

{% block title %}Quản lý lớp học{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item">
    <a href="{{ url_for('admin.dashboard') }}" class="text-decoration-none">
        <i class="fas fa-home me-1"></i>Trang chủ
    </a>
</li>
<li class="breadcrumb-item active" aria-current="page">
    Quản lý lớp học
</li>
{% endblock %}

{% block layout_content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <form class="row g-3" id="filterForm" autocomplete="off" onsubmit="return false;">
                        <div class="col-md-3">
                            <label class="form-label">Tìm kiếm</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="Tên lớp, phòng học...">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Khối lớp</label>
                            <select class="form-select" id="gradeFilter">
                                <option value="">Tất cả</option>
                                <option value="6">Khối 6</option>
                                <option value="7">Khối 7</option>
                                <option value="8">Khối 8</option>
                                <option value="9">Khối 9</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Trạng thái</label>
                            <select class="form-select" id="statusFilter">
                                <option value="">Tất cả</option>
                                <option value="active">Hoạt động</option>
                                <option value="inactive">Tạm khóa</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end gap-2">
                            <button type="button" class="btn btn-outline-secondary" onclick="resetFilters()" title="Đặt lại bộ lọc">
                                <i class="fas fa-redo"></i>
                            </button>
                            <button type="submit" class="btn btn-primary" id="searchBtn" title="Tìm kiếm">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Header -->
            <div class="page-header">
                <h2 class="page-header-title">
                    <i class="fas fa-chalkboard-teacher me-2" style="color: #3b82f6;"></i>
                    Danh sách lớp học
                </h2>
                <div class="page-header-actions">
                    <a href="{{ url_for('classroom.form') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        Thêm lớp học
                    </a>
                </div>
            </div>
            
            <!-- Classrooms Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="classroomsTable">
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>Tên lớp</th>
                                    <th>Khối lớp</th>
                                    <th>Phòng học</th>
                                    <th>Giáo viên chủ nhiệm</th>
                                    <th>Sĩ số</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <nav aria-label="Classroom pagination" class="mt-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                Hiển thị <span id="showingInfo">0 - 0 của 0</span>
                            </small>
                            <ul class="pagination pagination-sm mb-0" id="pagination">
                                <!-- Pagination will be populated by JavaScript -->
                            </ul>
                        </div>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPage = 1;
    let currentLimit = 10;
    let currentSearch = '';
    let currentGrade = '';
    let currentStatus = '';

    // Initialize classroom management
    function initializeClassroomManagement() {
        loadClassroomList();
        setupEventListeners();
    }

    // Setup event listeners
    function setupEventListeners() {
        // Submit filter form
        document.getElementById('filterForm').addEventListener('submit', function(e) {
            e.preventDefault();
            currentSearch = document.getElementById('searchInput').value;
            currentGrade = document.getElementById('gradeFilter').value;
            currentStatus = document.getElementById('statusFilter').value;
            currentPage = 1;
            loadClassroomList();
        });

        // Enter key in search input submits form
        document.getElementById('searchInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('searchBtn').click();
            }
        });
    }

    // Load classroom list
    async function loadClassroomList() {
        try {
            const params = new URLSearchParams({
                page: currentPage,
                limit: currentLimit,
                search: currentSearch,
                grade: currentGrade,
                status: currentStatus
            });

            const response = await fetch(`/classroom/api/list?${params}`);
            const data = await response.json();
            
            if (data.success) {
                console.log('Classroom pagination:', data.data.pagination);
                renderClassroomList(data.data.classrooms);
                renderPagination(data.data.pagination);
                updateShowingInfo(data.data.pagination);
            } else {
                window.FaceID?.NotificationSystem?.error(data.message || 'Lỗi khi tải danh sách lớp học');
            }
        } catch (error) {
            console.error('Error loading classrooms:', error);
            window.FaceID?.NotificationSystem?.error('Lỗi kết nối khi tải danh sách lớp học');
        }
    }

    // Render classroom list
    function renderClassroomList(classrooms) {
        const tbody = document.querySelector('#classroomsTable tbody');
        
        if (!classrooms || classrooms.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-muted py-4">
                        <i class="fas fa-school fa-2x mb-2 d-block"></i>
                        Không có lớp học nào
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = classrooms.map((classroom, index) => {
            const stt = (currentPage - 1) * currentLimit + index + 1;
            const statusBadge = classroom.is_active 
                ? '<span class="badge bg-success">Hoạt động</span>'
                : '<span class="badge bg-secondary">Tạm khóa</span>';
            
            const gradeBadge = `<span class="badge bg-info">Khối ${classroom.grade}</span>`;
            
            const studentCount = `${classroom.student_count || 0}/${classroom.max_student || 45}`;
            const isFullClass = (classroom.student_count || 0) >= (classroom.max_student || 45);
            const studentCountClass = isFullClass ? 'text-warning fw-bold' : '';

            return `
                <tr>
                    <td>${stt}</td>
                    <td>
                        <strong>${classroom.class_name}</strong>
                    </td>
                    <td>${gradeBadge}</td>
                    <td>${classroom.room_number || '<span class="text-muted">Chưa có</span>'}</td>
                    <td>${classroom.head_teacher || '<span class="text-muted">Chưa có</span>'}</td>
                    <td class="${studentCountClass}">${studentCount}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <a href="/classroom/edit/${classroom.id}" class="btn btn-outline-primary btn-sm" title="Chỉnh sửa">
                                <i class="fas fa-edit"></i>
                            </a>
                            ${classroom.is_active 
                                ? `<button type="button" class="btn btn-outline-warning btn-sm" onclick="toggleClassroomStatus(${classroom.id}, 'deactivate')" title="Tạm khóa">
                                    <i class="fas fa-lock"></i>
                                </button>`
                                : `<button type="button" class="btn btn-outline-success btn-sm" onclick="toggleClassroomStatus(${classroom.id}, 'activate')" title="Kích hoạt">
                                    <i class="fas fa-unlock"></i>
                                </button>`
                            }
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteClassroom(${classroom.id})" title="Xóa" ${classroom.student_count > 0 ? 'disabled' : ''}>
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Toggle classroom status
    window.toggleClassroomStatus = async function(classroomId, action) {
        const actionText = action === 'activate' ? 'kích hoạt' : 'khóa';
        const modalHtml = `
            <div class="modal fade" id="confirmModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Xác nhận ${actionText}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            Bạn có chắc chắn muốn ${actionText} lớp học này không?
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                            <button type="button" class="btn btn-primary" id="confirmBtn">Xác nhận</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHtml;
        document.body.appendChild(modalContainer);

        const modal = new bootstrap.Modal(modalContainer.querySelector('.modal'));
        const confirmBtn = modalContainer.querySelector('#confirmBtn');

        confirmBtn.addEventListener('click', async function() {
            modal.hide();

            try {
                const endpoint = action === 'activate' ? 'activate' : 'deactivate';
                const response = await fetch(`/classroom/api/${classroomId}/${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    window.FaceID?.NotificationSystem?.success(`${actionText.charAt(0).toUpperCase() + actionText.slice(1)} lớp học thành công`);
                    loadClassroomList();
                } else {
                    window.FaceID?.NotificationSystem?.error(data.message || `Lỗi khi ${actionText} lớp học`);
                }
            } catch (error) {
                console.error(`Error ${action} classroom:`, error);
                window.FaceID?.NotificationSystem?.error(`Lỗi kết nối khi ${actionText} lớp học`);
            } finally {
                modalContainer.remove();
            }
        });

        modal.show();
    };

    // Delete classroom
    window.deleteClassroom = async function(classroomId) {
        const modalHtml = `
            <div class="modal fade" id="confirmModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title text-danger">Xác nhận xóa</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            Bạn có chắc chắn muốn xóa lớp học này không? Hành động này không thể hoàn tác!
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                            <button type="button" class="btn btn-danger" id="confirmBtn">Xóa</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHtml;
        document.body.appendChild(modalContainer);

        const modal = new bootstrap.Modal(modalContainer.querySelector('.modal'));
        const confirmBtn = modalContainer.querySelector('#confirmBtn');

        confirmBtn.addEventListener('click', async function() {
            modal.hide();

            try {
                const response = await fetch(`/classroom/api/delete/${classroomId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    window.FaceID?.NotificationSystem?.success('Xóa lớp học thành công');
                    loadClassroomList();
                } else {
                    window.FaceID?.NotificationSystem?.error(data.message || 'Lỗi khi xóa lớp học');
                }
            } catch (error) {
                console.error('Error deleting classroom:', error);
                window.FaceID?.NotificationSystem?.error('Lỗi kết nối khi xóa lớp học');
            } finally {
                modalContainer.remove();
            }
        });

        modal.show();
    };

    // Reset filters
    window.resetFilters = function() {
        document.getElementById('searchInput').value = '';
        document.getElementById('gradeFilter').value = '';
        document.getElementById('statusFilter').value = '';
        
        currentPage = 1;
        currentSearch = '';
        currentGrade = '';
        currentStatus = '';
        
        loadClassroomList();
        if (window.FaceID && FaceID.NotificationSystem) {
            FaceID.NotificationSystem.success('Đã đặt lại bộ lọc');
        }
    };

    // Pagination
    function renderPagination(pagination) {
        const paginationEl = document.getElementById('pagination');
        const totalPages = pagination.pages;
        
        if (totalPages <= 1) {
            paginationEl.innerHTML = '';
            return;
        }

        let paginationHTML = '';
        
        // Previous button
        if (currentPage > 1) {
            paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage - 1})">‹</a></li>`;
        }
        
        // Page numbers
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);
        
        if (startPage > 1) {
            paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(1)">1</a></li>`;
            if (startPage > 2) {
                paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>`;
        }
        
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
            paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${totalPages})">${totalPages}</a></li>`;
        }
        
        // Next button
        if (currentPage < totalPages) {
            paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage + 1})">›</a></li>`;
        }
        
        paginationEl.innerHTML = paginationHTML;
    }

    // Change page
    window.changePage = function(page) {
        currentPage = page;
        loadClassroomList();
    };

    // Update showing info
    function updateShowingInfo(pagination) {
        const start = (currentPage - 1) * currentLimit + 1;
        const end = Math.min(currentPage * currentLimit, pagination.total);
        const total = pagination.total;
        
        document.getElementById('showingInfo').textContent = `${start} - ${end} của ${total}`;
    }

    // Initialize on page load
    initializeClassroomManagement();
});
</script>
{% endblock %}